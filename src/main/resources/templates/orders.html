<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <th:block th:replace="~{fragments/layout :: head('My Orders - Restaurant Store')}"></th:block>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Kantumruy+Pro:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Kantumruy Pro', sans-serif;
        }
        .status-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .status-PENDING { background-color: #fef3c7; color: #92400e; }
        .status-CONFIRMED { background-color: #dbeafe; color: #1e40af; }
        .status-PREPARING { background-color: #ede9fe; color: #5b21b6; }
        .status-READY { background-color: #e0e7ff; color: #3730a3; }
        .status-COMPLETED { background-color: #dcfce7; color: #166534; }
        .status-CANCELLED { background-color: #fee2e2; color: #991b1b; }
        .status-DELIVERED { background-color: #dcfce7; color: #166534; }
        .payment-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.35rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .payment-PENDING { background-color: #fef3c7; color: #92400e; }
        .payment-PROCESSING { background-color: #e0f2fe; color: #1e40af; }
        .payment-COMPLETED { background-color: #dcfce7; color: #166534; }
        .payment-FAILED { background-color: #fee2e2; color: #991b1b; }
        .payment-CANCELLED { background-color: #f1f5f9; color: #475569; }
        .payment-REFUNDED { background-color: #ede9fe; color: #5b21b6; }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-50 to-gray-100 min-h-screen">
    <th:block th:replace="~{fragments/layout :: header}"></th:block>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 py-8">
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-gray-800">My Orders</h1>
            <p class="text-gray-600 mt-2">Track and manage your orders</p>
        </div>

        <div th:if="${successMessage}" class="mb-6 rounded-lg border border-green-200 bg-green-50 px-4 py-3 text-green-700">
            <span th:text="${successMessage}"></span>
        </div>
        <div th:if="${errorMessage}" class="mb-6 rounded-lg border border-red-200 bg-red-50 px-4 py-3 text-red-700">
            <span th:text="${errorMessage}"></span>
        </div>

        <div th:if="${orders == null || #lists.isEmpty(orders)}" class="text-center py-20">
            <svg class="w-24 h-24 mx-auto text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>
            <p class="text-gray-500 text-lg mb-6">No orders yet</p>
            <button onclick="window.location.href='/menu'" class="px-6 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">
                Start Shopping
            </button>
        </div>

        <div th:if="${orders != null && !#lists.isEmpty(orders)}" class="space-y-6">
            <div th:each="order : ${orders}" class="bg-white rounded-xl shadow-md p-6" th:attr="data-order-id=${order.id}">
                <div class="flex flex-col md:flex-row md:items-center justify-between mb-4 pb-4 border-b">
                    <div>
                        <h3 class="text-xl font-bold text-gray-800 mb-1">
                            Order #<span th:text="${order.id}"></span>
                        </h3>
                        <p class="text-sm text-gray-500" th:text="${#temporals.format(order.createdAt, 'MMM dd, yyyy HH:mm')}"></p>
                    </div>
                    <div class="mt-3 md:mt-0 flex flex-col md:flex-row md:items-center gap-4 text-right md:text-left">
                        <span class="status-badge" th:classappend="' status-' + ${order.status}" th:text="${order.status}"
                              th:attr="data-status-badge=${order.id}"></span>
                        <span class="text-2xl font-bold text-red-600" th:text="${#numbers.formatDecimal(order.totalPrice, 0, 'COMMA', 0, 'POINT')} + '៛'"></span>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-2 space-y-3" th:attr="data-items-container=${order.id}">
                        <div th:each="item : ${order.orderItems}" class="flex items-center gap-4 py-2">
                            <img th:src="${item.productImageUrl != null ? item.productImageUrl : 'https://images.unsplash.com/photo-1546069901-ba9599a7e63c?auto=format&fit=crop&w=100&q=80'}"
                                 th:alt="${item.productName}"
                                 class="w-16 h-16 object-cover rounded-lg">
                            <div class="flex-1">
                                <h4 class="font-semibold text-gray-800" th:text="${item.productName}"></h4>
                                <p class="text-sm text-gray-500">
                                    <span th:text="${item.quantity}"></span>
                                    ×
                                    <span th:text="${#numbers.formatDecimal(item.unitPrice, 0, 'COMMA', 0, 'POINT')} + '៛'"></span>
                                </p>
                            </div>
                            <div class="text-right">
                                <p class="font-semibold text-gray-800" th:text="${#numbers.formatDecimal(item.totalPrice, 0, 'COMMA', 0, 'POINT')} + '៛'"></p>
                            </div>
                        </div>
                    </div>

                    <div class="space-y-4">
                        <div class="bg-gray-50 rounded-lg p-4">
                            <h4 class="font-semibold text-gray-800 mb-2">Payment</h4>
                            <p class="text-sm text-gray-600">
                                Method:
                                <span class="font-medium"
                                      th:text="${order.paymentMethod != null ? #strings.replace(order.paymentMethod.name(), '_', ' ') : 'N/A'}"
                                      th:attr="data-payment-method=${order.id}"></span>
                            </p>
                            <p class="text-sm text-gray-600">
                                Status:
                                <span class="payment-badge"
                                      th:classappend="${order.paymentStatus != null} ? ' payment-' + order.paymentStatus : ''"
                                      th:text="${order.paymentStatus != null ? #strings.replace(order.paymentStatus.name(), '_', ' ') : 'N/A'}"
                                      th:attr="data-payment-status=${order.id}"></span>
                            </p>
                        </div>

                        <div class="bg-blue-50 rounded-lg p-4"
                             th:if="${order.orderType == T(com.restaurant.store.entity.OrderType).DELIVERY}"
                             th:attr="data-delivery-card=${order.id}">
                            <h4 class="font-semibold text-gray-800 mb-2">Delivery</h4>
                            <p class="text-sm text-gray-600">
                                Status:
                                <span class="font-medium"
                                      th:text="${order.deliveryStatus != null ? #strings.replace(order.deliveryStatus.name(), '_', ' ') : 'Pending'}"
                                      th:attr="data-delivery-status=${order.id}"></span>
                            </p>
                            <p class="text-sm text-gray-600">
                                Driver:
                                <span class="font-medium"
                                      th:text="${order.deliveryDriverName != null ? order.deliveryDriverName : 'Not assigned yet'}"
                                      th:attr="data-delivery-driver=${order.id}"></span>
                                <span class="text-gray-400"
                                      th:text="${order.deliveryDriverPhone != null ? '(' + order.deliveryDriverPhone + ')' : ''}"
                                      th:attr="data-delivery-phone=${order.id}"></span>
                            </p>
                            <p class="text-sm text-gray-600" th:if="${order.deliveryEstimatedArrivalTime != null}">
                                ETA:
                                <span class="font-medium"
                                      th:text="${#temporals.format(order.deliveryEstimatedArrivalTime, 'MMM dd, yyyy HH:mm') }"
                                      th:attr="data-delivery-eta=${order.id}"></span>
                            </p>
                        </div>

                        <a th:href="@{/orders/{id}(id=${order.id})}"
                           class="inline-flex items-center justify-center w-full px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium text-gray-700 hover:bg-gray-100 transition-colors">
                            View Details
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <th:block th:replace="~{fragments/layout :: footer}"></th:block>
    <th:block th:replace="~{fragments/layout :: api-config}"></th:block>
    <th:block th:replace="~{fragments/layout :: auth-utils}"></th:block>

    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <script th:inline="javascript">
        const statusClassMap = {
            'PENDING': 'status-PENDING',
            'CONFIRMED': 'status-CONFIRMED',
            'PREPARING': 'status-PREPARING',
            'READY': 'status-READY',
            'COMPLETED': 'status-COMPLETED',
            'CANCELLED': 'status-CANCELLED',
            'DELIVERED': 'status-DELIVERED'
        };

        document.addEventListener('DOMContentLoaded', () => {
            const orderCards = document.querySelectorAll('[data-order-id]');
            if (!orderCards.length || typeof SockJS === 'undefined' || typeof Stomp === 'undefined') {
                return;
            }

            const socket = new SockJS('/ws');
            const stompClient = Stomp.over(socket);
            stompClient.reconnect_delay = 5000;

            stompClient.connect({}, () => {
                orderCards.forEach(card => {
                    const orderId = card.dataset.orderId;
                    stompClient.subscribe(`/topic/orders/${orderId}`, message => {
                        try {
                            const payload = JSON.parse(message.body);
                            updateOrderCard(orderId, payload);
                        } catch (error) {
                            console.error('Failed to parse order update', error);
                        }
                    });
                    stompClient.subscribe(`/topic/orders/${orderId}/status`, message => {
                        updateOrderStatus(orderId, message.body);
                    });
                });
            }, error => {
                console.warn('Unable to connect to order updates', error);
            });
        });

        function updateOrderStatus(orderId, status) {
            const badge = document.querySelector(`[data-status-badge="${orderId}"]`);
            if (!badge || !status) {
                return;
            }

            badge.textContent = formatEnumValue(status) || status;
            badge.className = 'status-badge';
            const normalized = statusClassMap[status] || 'status-PENDING';
            badge.classList.add(normalized);
        }

        function updateOrderCard(orderId, order) {
            if (!order) {
                return;
            }

            updateOrderStatus(orderId, order.status);

            const paymentMethodEl = document.querySelector(`[data-payment-method="${orderId}"]`);
            if (paymentMethodEl) {
                paymentMethodEl.textContent = formatEnumValue(order.paymentMethod) || 'N/A';
            }

            const paymentStatusEl = document.querySelector(`[data-payment-status="${orderId}"]`);
            updatePaymentStatus(paymentStatusEl, order.paymentStatus);

            const deliveryStatusEl = document.querySelector(`[data-delivery-status="${orderId}"]`);
            if (deliveryStatusEl) {
                deliveryStatusEl.textContent = formatEnumValue(order.deliveryStatus) || 'Pending';
            }

            const deliveryEtaEl = document.querySelector(`[data-delivery-eta="${orderId}"]`);
            if (deliveryEtaEl) {
                if (order.deliveryEstimatedArrivalTime) {
                    deliveryEtaEl.textContent = formatDate(order.deliveryEstimatedArrivalTime);
                } else {
                    deliveryEtaEl.textContent = 'N/A';
                }
            }

            const driverNameEl = document.querySelector(`[data-delivery-driver="${orderId}"]`);
            if (driverNameEl) {
                driverNameEl.textContent = order.deliveryDriverName || 'Not assigned yet';
            }

            const driverPhoneEl = document.querySelector(`[data-delivery-phone="${orderId}"]`);
            if (driverPhoneEl) {
                driverPhoneEl.textContent = order.deliveryDriverPhone ? `(${order.deliveryDriverPhone})` : '';
            }
        }

        function formatDate(value) {
            try {
                const date = new Date(value);
                if (!isNaN(date.getTime())) {
                    return date.toLocaleString('en-US', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                }
            } catch (error) {
                console.warn('Unable to format date', value, error);
            }
            return value;
        }

        const paymentStatusClassMap = {
            'PENDING': 'payment-PENDING',
            'PROCESSING': 'payment-PROCESSING',
            'COMPLETED': 'payment-COMPLETED',
            'FAILED': 'payment-FAILED',
            'CANCELLED': 'payment-CANCELLED',
            'REFUNDED': 'payment-REFUNDED'
        };

        function updatePaymentStatus(element, status) {
            if (!element) {
                return;
            }

            element.textContent = formatEnumValue(status) || 'N/A';
            element.className = 'payment-badge';

            if (status && paymentStatusClassMap[status]) {
                element.classList.add(paymentStatusClassMap[status]);
            }
        }

        function formatEnumValue(value) {
            if (!value) {
                return '';
            }

            return value
                .toString()
                .split('_')
                .map(part => part.charAt(0) + part.slice(1).toLowerCase())
                .join(' ');
        }
    </script>
</body>
</html>
