<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <th:block th:replace="~{fragments/layout :: head('Checkout - Restaurant Store')}"></th:block>
    <script src="https://js.stripe.com/v3/"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Kantumruy+Pro:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Kantumruy Pro', sans-serif;
        }
        
        .StripeElement {
            box-sizing: border-box;
            height: 40px;
            padding: 10px 12px;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            background-color: white;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            transition: box-shadow 150ms ease;
        }
        
        .StripeElement--focus {
            box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.1);
            border-color: #dc2626;
        }
        
        .StripeElement--invalid {
            border-color: #ef4444;
        }
        
        .StripeElement--webkit-autofill {
            background-color: #fefde8 !important;
        }
        
        #card-errors {
            color: #ef4444;
            font-size: 0.875rem;
            margin-top: 0.5rem;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-50 to-gray-100 min-h-screen">
    <th:block th:replace="~{fragments/layout :: header}"></th:block>

    <main class="max-w-5xl mx-auto px-4 sm:px-6 py-8" x-data="checkoutApp()" x-init="init()">
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-gray-800">Checkout</h1>
            <p class="text-gray-600 mt-2">Complete your order</p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Checkout Form -->
            <div class="lg:col-span-2">
                <div class="bg-white rounded-xl shadow-md p-6 space-y-6">
                    <!-- Delivery Information -->
                    <div>
                        <h2 class="text-xl font-bold text-gray-800 mb-4">Delivery Information</h2>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Order Type</label>
                                <select x-model="orderType" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent">
                                    <option value="DELIVERY">Delivery</option>
                                    <option value="TAKEAWAY">Takeaway</option>
                                </select>
                            </div>
                            
                            <div x-show="orderType === 'DELIVERY'">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Delivery Address</label>
                                <input type="text" x-model="deliveryAddress" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent" placeholder="Enter your delivery address">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Phone Number</label>
                                <input type="tel" x-model="phoneNumber" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent" placeholder="Enter your phone number">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Special Instructions (Optional)</label>
                                <textarea x-model="specialInstructions" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent" placeholder="Any special requests?"></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Payment Method -->
                    <div>
                        <h2 class="text-xl font-bold text-gray-800 mb-4">Payment Method</h2>
                        <div class="space-y-3">
                            <label class="flex items-center p-4 border-2 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors" :class="paymentMethod === 'CARD' ? 'border-red-600 bg-red-50' : 'border-gray-200'">
                                <input type="radio" x-model="paymentMethod" value="CARD" class="mr-3">
                                <div class="flex-1">
                                    <div class="font-semibold">Credit/Debit Card</div>
                                    <div class="text-sm text-gray-600">Pay securely with Stripe</div>
                                </div>
                                <svg class="w-12 h-8" viewBox="0 0 48 32" fill="none">
                                    <rect width="48" height="32" rx="4" fill="#635BFF"/>
                                    <text x="24" y="20" text-anchor="middle" fill="white" font-size="10" font-weight="bold">STRIPE</text>
                                </svg>
                            </label>
                            
                            <label class="flex items-center p-4 border-2 rounded-lg cursor-pointer hover:bg-gray-50 transition-colors" :class="paymentMethod === 'CASH' ? 'border-red-600 bg-red-50' : 'border-gray-200'">
                                <input type="radio" x-model="paymentMethod" value="CASH" class="mr-3">
                                <div class="flex-1">
                                    <div class="font-semibold">Cash on Delivery</div>
                                    <div class="text-sm text-gray-600">Pay when you receive your order</div>
                                </div>
                                <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path>
                                </svg>
                            </label>
                        </div>
                    </div>

                    <!-- Card Payment Details -->
                    <div x-show="paymentMethod === 'CARD'" x-transition>
                        <h3 class="text-lg font-semibold text-gray-800 mb-4">Card Details</h3>
                        <form id="payment-form">
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Card Number</label>
                                <div id="card-element"></div>
                                <div id="card-errors" role="alert"></div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Order Summary -->
            <div class="lg:col-span-1">
                <div class="bg-white rounded-xl shadow-md p-6 sticky top-24">
                    <h2 class="text-2xl font-bold text-gray-800 mb-6">Order Summary</h2>
                    
                    <div class="space-y-3 mb-6">
                        <div x-show="cart && cart.items && cart.items.length > 0">
                            <template x-for="item in cart.items" :key="item.id">
                                <div class="flex justify-between text-sm">
                                    <span x-text="`${item.productName} x ${item.quantity}`" class="text-gray-600"></span>
                                    <span x-text="formatPrice(item.subtotal)" class="font-medium"></span>
                                </div>
                            </template>
                        </div>
                        
                        <div class="border-t pt-3 space-y-2">
                            <div class="flex justify-between text-gray-600">
                                <span>Subtotal</span>
                                <span x-text="formatPrice(cart?.subtotal || 0)" class="font-medium"></span>
                            </div>
                            <div class="flex justify-between text-gray-600" x-show="orderType === 'DELIVERY'">
                                <span>Delivery Fee</span>
                                <span x-text="formatPrice(cart?.deliveryFee || 0)" class="font-medium"></span>
                            </div>
                            <div class="border-t pt-3 flex justify-between text-lg font-bold text-gray-800">
                                <span>Total</span>
                                <span x-text="formatPrice(orderType === 'DELIVERY' ? cart?.total || 0 : cart?.subtotal || 0)" class="text-red-600"></span>
                            </div>
                        </div>
                    </div>
                    
                    <button 
                        @click="placeOrder" 
                        :disabled="processing" 
                        :class="processing ? 'bg-gray-400 cursor-not-allowed' : 'bg-red-600 hover:bg-red-700'"
                        class="w-full text-white font-medium py-3 rounded-lg transition-colors mb-3">
                        <span x-show="!processing">Place Order</span>
                        <span x-show="processing">Processing...</span>
                    </button>
                    
                    <button 
                        onclick="window.location.href='/cart'" 
                        class="w-full bg-gray-100 text-gray-700 font-medium py-3 rounded-lg hover:bg-gray-200 transition-colors">
                        Back to Cart
                    </button>
                </div>
            </div>
        </div>
    </main>

    <th:block th:replace="~{fragments/layout :: footer}"></th:block>
    <th:block th:replace="~{fragments/layout :: api-config}"></th:block>
    <th:block th:replace="~{fragments/layout :: auth-utils}"></th:block>

    <script th:inline="javascript">
        /*<![CDATA[*/
        const STRIPE_PUBLIC_KEY = /*[[${stripePublicKey}]]*/ 'pk_test_key';
        
        function checkoutApp() {
            return {
                cart: null,
                orderType: 'DELIVERY',
                deliveryAddress: '',
                phoneNumber: '',
                specialInstructions: '',
                paymentMethod: 'CARD',
                processing: false,
                stripe: null,
                cardElement: null,
                
                async init() {
                    const token = localStorage.getItem('token');
                    
                    if (!token) {
                        alert('Please login to checkout');
                        window.location.href = '/login';
                        return;
                    }
                    
                    await this.loadCart();
                    await this.loadCustomerInfo();
                    this.initStripe();
                },
                
                async loadCart() {
                    const token = localStorage.getItem('token');
                    
                    try {
                        const response = await fetch(`${API_BASE_URL}/cart`, {
                            headers: {
                                'Authorization': `Bearer ${token}`
                            }
                        });
                        
                        const data = await response.json();
                        
                        if (response.ok && data.success && data.data) {
                            this.cart = data.data;
                            
                            if (this.cart.items.length === 0) {
                                alert('Your cart is empty');
                                window.location.href = '/menu';
                            }
                        }
                    } catch (error) {
                        console.error('Load cart error:', error);
                    }
                },
                
                async loadCustomerInfo() {
                    const customer = JSON.parse(localStorage.getItem('customer'));
                    if (customer) {
                        this.phoneNumber = customer.phone || '';
                        this.deliveryAddress = customer.address || '';
                    }
                },
                
                initStripe() {
                    this.stripe = Stripe(STRIPE_PUBLIC_KEY);
                    const elements = this.stripe.elements();
                    
                    this.cardElement = elements.create('card', {
                        style: {
                            base: {
                                fontSize: '16px',
                                color: '#32325d',
                                fontFamily: '"Kantumruy Pro", sans-serif',
                                '::placeholder': {
                                    color: '#aab7c4'
                                }
                            },
                            invalid: {
                                color: '#ef4444',
                                iconColor: '#ef4444'
                            }
                        }
                    });
                    
                    this.cardElement.mount('#card-element');
                    
                    this.cardElement.on('change', (event) => {
                        const displayError = document.getElementById('card-errors');
                        if (event.error) {
                            displayError.textContent = event.error.message;
                        } else {
                            displayError.textContent = '';
                        }
                    });
                },
                
                async placeOrder() {
                    if (this.processing) return;
                    
                    // Validate inputs
                    if (this.orderType === 'DELIVERY' && !this.deliveryAddress.trim()) {
                        alert('Please enter delivery address');
                        return;
                    }
                    
                    if (!this.phoneNumber.trim()) {
                        alert('Please enter phone number');
                        return;
                    }
                    
                    this.processing = true;
                    
                    try {
                        const token = localStorage.getItem('token');
                        
                        // Create order first
                        const orderItems = this.cart.items.map(item => ({
                            productId: item.productId,
                            quantity: item.quantity,
                            price: item.price
                        }));
                        
                        const orderResponse = await fetch(`${API_BASE_URL}/orders`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${token}`
                            },
                            body: JSON.stringify({
                                orderItems: orderItems,
                                orderType: this.orderType,
                                deliveryAddress: this.orderType === 'DELIVERY' ? this.deliveryAddress : null,
                                phoneNumber: this.phoneNumber,
                                specialInstructions: this.specialInstructions
                            })
                        });
                        
                        const orderData = await orderResponse.json();
                        
                        if (!orderResponse.ok || !orderData.success) {
                            throw new Error(orderData.message || 'Failed to create order');
                        }
                        
                        const orderId = orderData.data.id;
                        
                        // Process payment
                        let redirected = false;
                        if (this.paymentMethod === 'CARD') {
                            redirected = await this.processCardPayment(orderId, token);
                        } else {
                            await this.processCashPayment(orderId, token);
                        }
                        
                        // If redirected to Stripe (session mode), don't clear cart or show message
                        // Cart will be cleared on success page
                        if (redirected) {
                            return;
                        }
                        
                        // Clear cart
                        await fetch(`${API_BASE_URL}/cart/clear`, {
                            method: 'DELETE',
                            headers: {
                                'Authorization': `Bearer ${token}`
                            }
                        });
                        
                        // Update cart badge
                        if (typeof updateCartBadge === 'function') {
                            updateCartBadge();
                        }
                        
                        alert('Order placed successfully!');
                        window.location.href = '/orders';
                        
                    } catch (error) {
                        console.error('Place order error:', error);
                        alert(error.message || 'Failed to place order. Please try again.');
                    } finally {
                        this.processing = false;
                    }
                },
                
                async processCardPayment(orderId, token) {
                    // Create payment using web payment endpoint (supports both intent and session)
                    const paymentResponse = await fetch(`${API_BASE_URL}/web/payment/create/${orderId}`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    
                    const paymentData = await paymentResponse.json();
                    
                    if (!paymentResponse.ok || !paymentData.success) {
                        throw new Error('Failed to create payment');
                    }
                    
                    const payment = paymentData.data;
                    
                    // Check payment type and handle accordingly
                    if (payment.type === 'session') {
                        // Redirect to Stripe Checkout
                        window.location.href = payment.sessionUrl;
                        return true; // Indicate that user was redirected
                    } else {
                        // Payment Intent - process with custom UI
                        const clientSecret = payment.clientSecret;
                        
                        // Confirm card payment
                        const {error, paymentIntent} = await this.stripe.confirmCardPayment(clientSecret, {
                            payment_method: {
                                card: this.cardElement
                            }
                        });
                        
                        if (error) {
                            throw new Error(error.message);
                        }
                        
                        if (paymentIntent.status === 'succeeded') {
                            // Confirm payment on backend
                            await fetch(`${API_BASE_URL}/orders/${orderId}/pay`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${token}`
                                },
                                body: JSON.stringify({
                                    paymentMethod: 'STRIPE',
                                    transactionId: paymentIntent.id
                                })
                            });
                        }
                        return false; // Not redirected
                    }
                },
                
                async processCashPayment(orderId, token) {
                    await fetch(`${API_BASE_URL}/orders/${orderId}/pay`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({
                            paymentMethod: 'CASH'
                        })
                    });
                },
                
                formatPrice(price) {
                    if (typeof price === 'number') {
                        return `${price.toLocaleString()}áŸ›`;
                    }
                    return price;
                }
            }
        }
        /*]]>*/
    </script>
</body>
</html>
