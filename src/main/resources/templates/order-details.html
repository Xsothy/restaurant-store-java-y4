<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <th:block th:replace="~{fragments/layout :: head('Order Details - Restaurant Store')}"></th:block>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Kantumruy+Pro:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Kantumruy Pro', sans-serif;
            background: #f6f6f8;
        }
        .card-shell {
            background: #ffffff;
            border-radius: 24px;
            border: 1px solid #f0f1f5;
            box-shadow: 0 20px 45px rgba(15, 23, 42, 0.06);
        }
        .section-label {
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            font-weight: 600;
            color: #9ca3af;
        }
        .status-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.45rem 0.95rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .status-PENDING { background-color: #fef3c7; color: #92400e; }
        .status-CONFIRMED { background-color: #dbeafe; color: #1e40af; }
        .status-PREPARING { background-color: #ede9fe; color: #5b21b6; }
        .status-READY { background-color: #e0e7ff; color: #3730a3; }
        .status-OUT_FOR_DELIVERY { background-color: #cffafe; color: #0f766e; }
        .status-COMPLETED { background-color: #dcfce7; color: #166534; }
        .status-CANCELLED { background-color: #fee2e2; color: #991b1b; }
        .status-DELIVERED { background-color: #dcfce7; color: #166534; }
        .payment-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.35rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .payment-PENDING { background-color: #fef3c7; color: #92400e; }
        .payment-AWAITING_SESSION { background-color: #fef3c7; color: #92400e; }
        .payment-AWAITING_WEBHOOK { background-color: #e0f2fe; color: #075985; }
        .payment-CASH_PENDING { background-color: #fff7ed; color: #9a3412; }
        .payment-PROCESSING { background-color: #e0f2fe; color: #1e40af; }
        .payment-COMPLETED { background-color: #dcfce7; color: #166534; }
        .payment-FAILED { background-color: #fee2e2; color: #991b1b; }
        .payment-CANCELLED { background-color: #f1f5f9; color: #475569; }
        .payment-REFUNDED { background-color: #ede9fe; color: #5b21b6; }
        .order-tracking-wrapper {
            position: relative;
        }
        .order-tracking-timeline {
            position: relative;
            padding-left: 2.5rem;
            margin-top: 1.5rem;
        }
        .order-tracking-timeline::before {
            content: '';
            position: absolute;
            left: 0.95rem;
            top: 0;
            bottom: 0;
            width: 2px;
            background: linear-gradient(180deg, rgba(226, 232, 240, 0.8), rgba(226, 232, 240, 0));
        }
        .tracking-step {
            position: relative;
            padding-left: 1.25rem;
            padding-bottom: 1.75rem;
        }
        .tracking-step:last-child {
            padding-bottom: 0;
        }
        .tracking-marker {
            position: absolute;
            left: -0.95rem;
            top: 0;
            width: 1.7rem;
            height: 1.7rem;
            border-radius: 9999px;
            border: 3px solid #dbeafe;
            background-color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.65rem;
            font-weight: 700;
            color: #1e40af;
            transition: all 0.3s ease;
        }
        .tracking-step-upcoming .tracking-marker {
            border-color: #e5e7eb;
            color: #94a3b8;
        }
        .tracking-step-completed .tracking-marker {
            border-color: #86efac;
            background-color: #86efac;
            color: #14532d;
            box-shadow: 0 10px 25px -12px rgba(34, 197, 94, 0.7);
        }
        .tracking-step-active .tracking-marker {
            border-color: #3b82f6;
            background-color: #2563eb;
            color: #ffffff;
            box-shadow: 0 10px 25px -12px rgba(37, 99, 235, 0.6);
        }
        .tracking-step-cancelled .tracking-marker {
            border-color: #fecaca;
            background-color: #fecaca;
            color: #991b1b;
            box-shadow: 0 10px 25px -15px rgba(185, 28, 28, 0.5);
        }
        .tracking-connector {
            display: none;
        }
        @media (min-width: 768px) {
            .order-tracking-timeline {
                padding-left: 2.75rem;
            }
        }
    </style>
</head>
<body class="min-h-screen">
    <th:block th:replace="~{fragments/layout :: header}"></th:block>

    <main class="max-w-3xl mx-auto px-4 sm:px-0 py-8" th:if="${order}">
        <div class="mb-4 space-y-3">
            <div class="rounded-2xl border border-green-200 bg-green-50 px-4 py-3 text-green-700" th:text="${successMessage}"
                 th:if="${successMessage}"></div>
            <div class="rounded-2xl border border-red-200 bg-red-50 px-4 py-3 text-red-700" th:text="${errorMessage}"
                 th:if="${errorMessage}"></div>
        </div>

        <div class="space-y-6" th:attr="data-order-id=${order.id}">
            <div class="card-shell p-6">
                <div class="flex items-start justify-between gap-6">
                    <div>
                        <p class="section-label">Order</p>
                        <h1 class="text-3xl font-semibold text-gray-900" th:text="${'Order #' + order.id}"></h1>
                        <p class="text-sm text-gray-500 mt-1">Placed on
                            <span th:text="${#temporals.format(order.createdAt, 'MMM dd, yyyy • HH:mm')}"></span>
                        </p>
                    </div>
                    <div class="text-right">
                        <p class="section-label text-right">Total</p>
                        <p class="text-2xl font-bold text-gray-900"
                           th:text="${#numbers.formatDecimal(order.totalPrice, 0, 'COMMA', 0, 'POINT') + ' ៛'}"></p>
                        <span class="status-badge mt-3 inline-flex" th:classappend="' status-' + ${order.status}"
                              th:text="${order.status}" th:attr="data-status-badge=${order.id}"></span>
                    </div>
                </div>
                <div class="mt-5 grid grid-cols-1 sm:grid-cols-2 gap-4 text-sm text-gray-600">
                    <div>
                        <p class="text-gray-500">Order Type</p>
                        <p class="font-semibold text-gray-900" th:text="${order.orderType}"></p>
                    </div>
                    <div>
                        <p class="text-gray-500">Contact</p>
                        <p class="font-semibold text-gray-900">
                            <span th:text="${order.customerName}"></span>
                            <span th:if="${order.phoneNumber != null}"> • <span th:text="${order.phoneNumber}"></span></span>
                        </p>
                    </div>
                    <div th:if="${order.estimatedDeliveryTime != null}">
                        <p class="text-gray-500">ETA</p>
                        <p class="font-semibold text-gray-900"
                           th:text="${#temporals.format(order.estimatedDeliveryTime, 'MMM dd, yyyy • HH:mm')}"></p>
                    </div>
                    <div th:if="${order.deliveryAddress != null}">
                        <p class="text-gray-500">Address</p>
                        <p class="font-semibold text-gray-900" th:text="${order.deliveryAddress}"></p>
                    </div>
                </div>
            </div>

            <div class="card-shell p-6 order-tracking-wrapper"
                 th:with="trackingStatuses=${T(java.util.Arrays).asList(
                        T(com.restaurant.store.entity.OrderStatus).PENDING,
                        T(com.restaurant.store.entity.OrderStatus).CONFIRMED,
                        T(com.restaurant.store.entity.OrderStatus).PREPARING,
                        T(com.restaurant.store.entity.OrderStatus).READY,
                        T(com.restaurant.store.entity.OrderStatus).OUT_FOR_DELIVERY,
                        T(com.restaurant.store.entity.OrderStatus).DELIVERED
                 )},
                 statusLabels=${T(java.util.Map).of(
                        T(com.restaurant.store.entity.OrderStatus).PENDING, 'Pending Confirmation',
                        T(com.restaurant.store.entity.OrderStatus).CONFIRMED, 'Confirmed',
                        T(com.restaurant.store.entity.OrderStatus).PREPARING, 'Preparing Order',
                        T(com.restaurant.store.entity.OrderStatus).READY, 'Ready for Pickup',
                        T(com.restaurant.store.entity.OrderStatus).OUT_FOR_DELIVERY, 'Out for Delivery',
                        T(com.restaurant.store.entity.OrderStatus).DELIVERED, 'Completed'
                 )},
                 currentIndex=${trackingStatuses.contains(order.status) ? trackingStatuses.indexOf(order.status) : -1}">
                <div class="flex flex-col gap-3 md:flex-row md:items-start md:justify-between">
                    <div>
                        <p class="section-label">Order Progress</p>
                        <h2 class="text-xl font-semibold text-gray-900">Track your meal</h2>
                        <p class="text-sm text-gray-500"
                           th:attr="data-tracking-description=${order.id}"
                           th:text="${order.status == T(com.restaurant.store.entity.OrderStatus).CANCELLED
                                ? 'This order was cancelled before completion.'
                                : 'See what step comes next so you always know what to expect.'}"></p>
                    </div>
                    <div class="text-sm text-gray-500 flex items-center gap-2"
                         th:attr="data-order-updated-container=${order.id}"
                         th:classappend="${order.updatedAt == null} ? ' hidden' : ''">
                        <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <span>Updated</span>
                        <span class="font-medium text-gray-700"
                              th:text="${order.updatedAt != null ? #temporals.format(order.updatedAt, 'MMM dd, yyyy HH:mm') : ''}"
                              th:attr="data-order-updated=${order.id}"></span>
                    </div>
                </div>

                <div class="bg-gray-50 rounded-2xl p-4 mt-4"
                     th:with="stepCount=${trackingStatuses.size()},
                              isCancelled=${order.status == T(com.restaurant.store.entity.OrderStatus).CANCELLED},
                              hasValidStatus=${trackingStatuses.contains(order.status)},
                              completedSteps=${isCancelled ? 0 : (hasValidStatus ? currentIndex + 1 : 0)},
                              progressPercent=${isCancelled ? 0 : (hasValidStatus ? (completedSteps * 100.0) / stepCount : 0)},
                              nextStep=${(!isCancelled && hasValidStatus && currentIndex < stepCount - 1)
                                        ? trackingStatuses.get(currentIndex + 1) : null},
                              remainingSteps=${(!isCancelled && hasValidStatus && currentIndex < stepCount - 1)
                                        ? trackingStatuses.subList(currentIndex + 1, stepCount)
                                        : T(java.util.Collections).emptyList()}">
                    <div class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
                        <div>
                            <p class="section-label">Progress</p>
                            <p class="text-2xl font-semibold text-gray-900"
                               th:attr="data-tracking-progress-label=${order.id}"
                               th:text="${isCancelled
                                        ? 'Order Cancelled'
                                        : (hasValidStatus
                                            ? 'Step ' + completedSteps + ' of ' + stepCount
                                            : 'Awaiting first update')}">Step 0 of 6</p>
                        </div>
                        <div class="text-left md:text-right">
                            <p class="section-label">Next Step</p>
                            <p class="text-sm font-semibold text-gray-800"
                               th:classappend="${isCancelled} ? ' text-red-600' : ''"
                               th:attr="data-tracking-next=${order.id}"
                               th:text="${isCancelled
                                        ? 'No further steps'
                                        : (!hasValidStatus
                                            ? 'Next: ' + statusLabels[T(com.restaurant.store.entity.OrderStatus).PENDING]
                                            : (nextStep != null
                                                ? 'Next: ' + statusLabels[nextStep]
                                                : 'All steps completed'))}">Next: Pending Confirmation</p>
                        </div>
                    </div>
                    <div class="relative mt-4 h-1.5 bg-white rounded-full overflow-hidden">
                        <div class="absolute inset-y-0 left-0 bg-gradient-to-r from-blue-400 via-blue-500 to-indigo-500 rounded-full transition-all duration-500"
                             style="width: 0%;"
                             th:styleappend="${'width: ' + #numbers.formatDecimal(progressPercent, 0, 'POINT', 0, 'POINT') + '%;'}"
                             th:attr="data-tracking-progress=${order.id}"></div>
                    </div>
                    <p class="text-sm text-gray-600 mt-3"
                       th:attr="data-tracking-remaining=${order.id}">
                        <span th:if="${isCancelled}">This order was cancelled before completion.</span>
                        <span th:if="${!isCancelled && !hasValidStatus}">We will show the remaining steps once your order is confirmed.</span>
                        <span th:if="${!isCancelled && hasValidStatus && currentIndex >= stepCount - 1}">All steps are complete. Enjoy your meal!</span>
                        <span th:if="${!isCancelled && hasValidStatus && currentIndex < stepCount - 1}">
                            Still to come:
                            <span th:each="remainingStep, iter : ${remainingSteps}">
                                <span th:text="${statusLabels[remainingStep]}"></span>
                                <span th:if="${!iter.last}"> → </span>
                            </span>
                        </span>
                    </p>
                </div>

                <div class="order-tracking-timeline"
                     th:attr="data-tracking='${order.id}', data-tracking-status='${order.status}'">
                    <div th:each="step, iterStat : ${trackingStatuses}"
                         th:with="stepIndex=${iterStat.index}"
                         th:class="${'tracking-step ' +
                                (order.status == T(com.restaurant.store.entity.OrderStatus).CANCELLED
                                    ? (stepIndex == 0 ? 'tracking-step-cancelled' : 'tracking-step-upcoming')
                                    : (currentIndex > stepIndex
                                        ? 'tracking-step-completed'
                                        : (currentIndex == stepIndex ? 'tracking-step-active' : 'tracking-step-upcoming')))}"
                         th:attr="data-tracking-step=${step.name()}">
                        <div class="tracking-marker" th:text="${stepIndex + 1}"></div>
                        <div class="tracking-connector" aria-hidden="true"></div>
                        <div class="space-y-1">
                            <p class="text-xs uppercase tracking-wide text-gray-400"
                               th:text="${'Step ' + (stepIndex + 1) + ' of ' + trackingStatuses.size()}"></p>
                            <p class="font-semibold text-gray-800" th:text="${statusLabels[step]}"></p>
                            <p class="text-sm text-gray-500" th:switch="${step}">
                                <span th:case="${T(com.restaurant.store.entity.OrderStatus).PENDING}">We received your order.</span>
                                <span th:case="${T(com.restaurant.store.entity.OrderStatus).CONFIRMED}">Restaurant confirmed the order.</span>
                                <span th:case="${T(com.restaurant.store.entity.OrderStatus).PREPARING}">Chef is preparing your meal.</span>
                                <span th:case="${T(com.restaurant.store.entity.OrderStatus).READY}">Order ready for pickup.</span>
                                <span th:case="${T(com.restaurant.store.entity.OrderStatus).OUT_FOR_DELIVERY}">Rider is on the way.</span>
                                <span th:case="${T(com.restaurant.store.entity.OrderStatus).DELIVERED}">Delivered. Enjoy!</span>
                                <span th:case="*">Stay tuned for the next update.</span>
                            </p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="grid gap-4 md:grid-cols-2">
                <div class="card-shell p-5 space-y-2"
                     th:if="${order.orderType == T(com.restaurant.store.entity.OrderType).DELIVERY}"
                     th:attr="data-delivery-card=${order.id}">
                    <p class="section-label">Delivery partner</p>
                    <p class="text-lg font-semibold text-gray-900"
                       th:text="${order.deliveryDriverName != null ? order.deliveryDriverName : 'Driver assigned soon'}"
                       th:attr="data-delivery-driver=${order.id}"></p>
                    <p class="text-sm text-gray-500">
                        Contact:
                        <span class="font-medium text-gray-900"
                              th:text="${order.deliveryDriverPhone != null ? order.deliveryDriverPhone : 'Not available yet'}"
                              th:attr="data-delivery-phone=${order.id}"></span>
                    </p>
                    <p class="text-sm text-gray-500">
                        Status:
                        <span class="font-medium text-gray-900"
                              th:text="${order.deliveryStatus != null ? #strings.replace(order.deliveryStatus.name(), '_', ' ') : 'Pending'}"
                              th:attr="data-delivery-status=${order.id}"></span>
                    </p>
                    <p class="text-sm text-gray-500" th:if="${order.deliveryEstimatedArrivalTime != null}">
                        ETA: <span class="font-medium text-gray-900"
                                    th:text="${#temporals.format(order.deliveryEstimatedArrivalTime, 'MMM dd, yyyy HH:mm')}"
                                    th:attr="data-delivery-eta=${order.id}"></span>
                    </p>
                    <p class="text-sm text-gray-500" th:if="${order.deliveryActualDeliveryTime != null}">
                        Delivered: <span class="font-medium text-gray-900"
                                          th:text="${#temporals.format(order.deliveryActualDeliveryTime, 'MMM dd, yyyy HH:mm')}"></span>
                    </p>
                </div>
                <div class="card-shell p-5 space-y-2">
                    <p class="section-label">Delivery details</p>
                    <p class="text-sm text-gray-500">Special instructions</p>
                    <p class="text-base text-gray-900" th:text="${order.specialInstructions != null ? order.specialInstructions : 'No additional instructions'}"></p>
                    <p class="text-sm text-gray-500" th:if="${order.deliveryAddress != null}">Address</p>
                    <p class="text-base text-gray-900" th:if="${order.deliveryAddress != null}" th:text="${order.deliveryAddress}"></p>
                </div>
            </div>

            <div class="card-shell p-6">
                <h2 class="text-lg font-semibold text-gray-900 mb-4">Order Items</h2>
                <div class="space-y-3" th:attr="data-items-container=${order.id}">
                    <div th:each="item : ${order.orderItems}" class="flex items-center justify-between py-3 border-b border-gray-100 last:border-0">
                        <div class="flex items-center gap-3">
                            <img th:src="${item.productImageUrl != null ? item.productImageUrl : '/images/placeholder-food.jpg'}"
                                 th:alt="${item.productName}"
                                 class="w-12 h-12 rounded-xl object-cover"
                                 onerror="this.src='/images/placeholder-food.jpg'" />
                            <div>
                                <p th:text="${item.productName}" class="font-medium text-gray-900"></p>
                                <p class="text-sm text-gray-500">
                                    Qty <span th:text="${item.quantity}"></span>
                                    •
                                    <span th:text="${#numbers.formatDecimal(item.unitPrice, 0, 'COMMA', 0, 'POINT') + '៛'}"></span>
                                </p>
                            </div>
                        </div>
                        <div class="text-right">
                            <p th:text="${#numbers.formatDecimal(item.totalPrice, 0, 'COMMA', 0, 'POINT') + '៛'}" class="font-semibold text-gray-900"></p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="grid gap-4 md:grid-cols-2">
                <div class="card-shell p-5 space-y-2">
                    <p class="section-label">Payment summary</p>
                    <p class="text-sm text-gray-600">
                        Method:
                        <span class="font-medium"
                              th:text="${order.paymentMethod != null ? #strings.replace(order.paymentMethod.name(), '_', ' ') : 'N/A'}"
                              th:attr="data-payment-method=${order.id}"></span>
                    </p>
                    <p class="text-sm text-gray-600 flex items-center gap-2">
                        Status:
                        <span class="payment-badge"
                              th:classappend="${order.paymentStatus != null} ? ' payment-' + order.paymentStatus : ''"
                              th:text="${order.paymentStatus != null ? #strings.replace(order.paymentStatus.name(), '_', ' ') : 'N/A'}"
                              th:attr="data-payment-status=${order.id}"></span>
                    </p>
                    <p class="text-sm text-gray-600" th:if="${order.paymentPaidAt != null}">
                        Paid on:
                        <span class="font-medium"
                              th:text="${#temporals.format(order.paymentPaidAt, 'MMM dd, yyyy HH:mm')}"></span>
                    </p>
                    <p class="text-sm text-gray-600" th:if="${order.paymentTransactionId != null}">
                        Transaction ID:
                        <span class="font-medium" th:text="${order.paymentTransactionId}"></span>
                    </p>
                </div>
                <div class="card-shell p-5 space-y-2">
                    <p class="section-label">Need to change?</p>
                    <p class="text-sm text-gray-600">We can cancel your order until the restaurant confirms it.</p>
                    <div class="flex flex-wrap gap-3">
                        <button onclick="window.location.href='/orders'"
                                class="flex-1 rounded-xl border border-gray-200 bg-white px-4 py-3 text-sm font-medium text-gray-700 hover:bg-gray-50">
                            Back to orders
                        </button>
                        <form class="flex-1"
                              th:if="${order.status == 'PENDING' or order.status == 'CONFIRMED'}"
                              th:action="@{/orders/{orderId}/cancel(orderId=${order.id})}" method="post"
                              onsubmit="return confirm('Are you sure you want to cancel this order?');">
                            <button type="submit"
                                    class="w-full rounded-xl bg-red-600 px-4 py-3 text-sm font-semibold text-white hover:bg-red-700">
                                Cancel order
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 py-8" th:unless="${order}">
        <div class="max-w-2xl mx-auto mb-6" th:if="${errorMessage}">
            <div class="rounded-lg border border-red-200 bg-red-50 px-4 py-3 text-red-700" th:text="${errorMessage}"></div>
        </div>
        <div class="text-center py-20">
            <div class="text-gray-400 mb-4">
                <svg class="w-24 h-24 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 011-18 0 9 9 0 0118 0z"></path>
                </svg>
            </div>
            <h3 class="text-xl font-semibold text-gray-600 mb-2">Order Not Found</h3>
            <p class="text-gray-500 mb-6"
               th:text="${errorMessage != null ? errorMessage : 'The order you\'re looking for doesn\'t exist or has been removed.'}">
                The order you're looking for doesn't exist or has been removed.
            </p>
            <button onclick="window.location.href='/orders'" class="bg-gray-900 text-white px-6 py-3 rounded-md font-medium hover:bg-gray-800 transition-colors">
                Back to Orders
            </button>
        </div>
    </main>

    <th:block th:replace="~{fragments/layout :: footer}"></th:block>
    <th:block th:replace="~{fragments/layout :: api-config}"></th:block>
    <th:block th:replace="~{fragments/layout :: auth-utils}"></th:block>

    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <script th:inline="javascript">
        const detailStatusClassMap = {
            'PENDING': 'status-PENDING',
            'CONFIRMED': 'status-CONFIRMED',
            'PREPARING': 'status-PREPARING',
            'READY': 'status-READY',
            'OUT_FOR_DELIVERY': 'status-OUT_FOR_DELIVERY',
            'COMPLETED': 'status-COMPLETED',
            'CANCELLED': 'status-CANCELLED',
            'DELIVERED': 'status-DELIVERED'
        };

        const trackingStatuses = ['PENDING', 'CONFIRMED', 'PREPARING', 'READY', 'OUT_FOR_DELIVERY', 'DELIVERED'];
        const trackingStatusFriendlyNames = {
            'PENDING': 'Pending Confirmation',
            'CONFIRMED': 'Confirmed',
            'PREPARING': 'Preparing Order',
            'READY': 'Ready for Pickup',
            'OUT_FOR_DELIVERY': 'Out for Delivery',
            'DELIVERED': 'Completed'
        };

        document.addEventListener('DOMContentLoaded', () => {
            const container = document.querySelector('[data-order-id]');
            if (!container) {
                return;
            }

            const orderId = container.dataset.orderId;
            const trackingContainer = document.querySelector(`[data-tracking="${orderId}"]`);
            if (trackingContainer) {
                updateTrackingSteps(orderId, trackingContainer.dataset.trackingStatus);
            }

            if (typeof SockJS === 'undefined' || typeof Stomp === 'undefined') {
                return;
            }

            const socket = new SockJS('/ws');
            const stompClient = Stomp.over(socket);
            stompClient.reconnect_delay = 5000;

            stompClient.connect({}, () => {
                stompClient.subscribe(`/topic/orders/${orderId}`, message => {
                    try {
                        const payload = JSON.parse(message.body);
                        updateOrderDetails(orderId, payload);
                    } catch (error) {
                        console.error('Failed to parse order update', error);
                    }
                });
                stompClient.subscribe(`/topic/orders/${orderId}/status`, message => {
                    updateOrderStatus(orderId, message.body);
                });
            }, error => {
                console.warn('Unable to connect to order updates', error);
            });
        });

        function updateOrderStatus(orderId, status) {
            const badge = document.querySelector(`[data-status-badge="${orderId}"]`);
            if (!badge || !status) {
                return;
            }
            badge.textContent = formatEnumValue(status) || status;
            badge.className = 'status-badge';
            badge.classList.add(detailStatusClassMap[status] || 'status-PENDING');

            updateTrackingSteps(orderId, status);
        }

        function updateOrderDetails(orderId, order) {
            if (!order) {
                return;
            }

            updateOrderStatus(orderId, order.status);

            updateTrackingSteps(orderId, order.status);

            if (order.updatedAt) {
                updateLastUpdated(orderId, order.updatedAt);
            }

            const paymentMethodEl = document.querySelector(`[data-payment-method="${orderId}"]`);
            if (paymentMethodEl) {
                paymentMethodEl.textContent = formatEnumValue(order.paymentMethod) || 'N/A';
            }

            const paymentStatusEl = document.querySelector(`[data-payment-status="${orderId}"]`);
            updatePaymentStatus(paymentStatusEl, order.paymentStatus);

            const deliveryStatusEl = document.querySelector(`[data-delivery-status="${orderId}"]`);
            if (deliveryStatusEl) {
                deliveryStatusEl.textContent = formatEnumValue(order.deliveryStatus) || 'Pending';
            }

            const deliveryEtaEl = document.querySelector(`[data-delivery-eta="${orderId}"]`);
            if (deliveryEtaEl) {
                if (order.deliveryEstimatedArrivalTime) {
                    deliveryEtaEl.textContent = formatDate(order.deliveryEstimatedArrivalTime);
                } else {
                    deliveryEtaEl.textContent = 'N/A';
                }
            }

            const driverNameEl = document.querySelector(`[data-delivery-driver="${orderId}"]`);
            if (driverNameEl) {
                driverNameEl.textContent = order.deliveryDriverName || 'Not assigned yet';
            }

            const driverPhoneEl = document.querySelector(`[data-delivery-phone="${orderId}"]`);
            if (driverPhoneEl) {
                driverPhoneEl.textContent = order.deliveryDriverPhone || 'Not available yet';
            }
        }

        function updateTrackingSteps(orderId, status) {
            if (!orderId) {
                return;
            }

            const trackingContainer = document.querySelector(`[data-tracking="${orderId}"]`);
            if (!trackingContainer) {
                return;
            }

            if (status) {
                trackingContainer.dataset.trackingStatus = status;
            } else {
                status = trackingContainer.dataset.trackingStatus;
            }

            const steps = trackingContainer.querySelectorAll('[data-tracking-step]');
            if (!steps.length) {
                return;
            }

            const isCancelled = status === 'CANCELLED';
            const activeIndex = trackingStatuses.indexOf(status);

            steps.forEach((step, index) => {
                step.classList.remove('tracking-step-completed', 'tracking-step-active', 'tracking-step-upcoming', 'tracking-step-cancelled');

                if (isCancelled) {
                    if (index === 0) {
                        step.classList.add('tracking-step-cancelled');
                    } else {
                        step.classList.add('tracking-step-upcoming');
                    }
                    return;
                }

                if (activeIndex === -1) {
                    step.classList.add('tracking-step-upcoming');
                    return;
                }

                if (index < activeIndex) {
                    step.classList.add('tracking-step-completed');
                } else if (index === activeIndex) {
                    step.classList.add('tracking-step-active');
                } else {
                    step.classList.add('tracking-step-upcoming');
                }
            });

            updateTrackingDescription(orderId, status);
            updateTrackingProgress(orderId, status);
        }

        function updateLastUpdated(orderId, timestamp) {
            const container = document.querySelector(`[data-order-updated-container="${orderId}"]`);
            const label = document.querySelector(`[data-order-updated="${orderId}"]`);

            if (!container || !label) {
                return;
            }

            container.classList.remove('hidden');
            label.textContent = formatDate(timestamp);
        }

        function updateTrackingDescription(orderId, status) {
            const description = document.querySelector(`[data-tracking-description="${orderId}"]`);
            if (!description) {
                return;
            }

            if (status === 'CANCELLED') {
                description.textContent = 'This order was cancelled before completion.';
                return;
            }

            const activeIndex = trackingStatuses.indexOf(status);
            if (activeIndex === -1) {
                description.textContent = 'See what step comes next so you always know what to expect.';
                return;
            }

            if (activeIndex >= trackingStatuses.length - 1) {
                description.textContent = 'Your meal has been delivered. Enjoy every bite!';
                return;
            }

            const nextStatus = trackingStatuses[activeIndex + 1];
            description.textContent = `${formatTrackingStatus(status)} stage in progress. Next: ${formatTrackingStatus(nextStatus)}.`;
        }

        function updateTrackingProgress(orderId, status) {
            const progressBar = document.querySelector(`[data-tracking-progress="${orderId}"]`);
            const progressLabel = document.querySelector(`[data-tracking-progress-label="${orderId}"]`);
            const nextLabel = document.querySelector(`[data-tracking-next="${orderId}"]`);
            const remainingLabel = document.querySelector(`[data-tracking-remaining="${orderId}"]`);

            if (!progressBar || !progressLabel || !remainingLabel) {
                return;
            }

            const totalSteps = trackingStatuses.length;
            const isCancelled = status === 'CANCELLED';
            const activeIndex = trackingStatuses.indexOf(status);
            const hasValidStatus = activeIndex >= 0;
            const completedSteps = isCancelled ? 0 : (hasValidStatus ? activeIndex + 1 : 0);
            const progressPercent = isCancelled ? 0 : (completedSteps / totalSteps) * 100;

            progressBar.style.width = `${Math.min(100, Math.max(0, progressPercent))}%`;

            if (progressLabel) {
                if (isCancelled) {
                    progressLabel.textContent = 'Order Cancelled';
                } else if (hasValidStatus) {
                    progressLabel.textContent = `Step ${completedSteps} of ${totalSteps}`;
                } else {
                    progressLabel.textContent = 'Awaiting first update';
                }
            }

            if (nextLabel) {
                if (isCancelled) {
                    nextLabel.textContent = 'No further steps';
                    nextLabel.classList.add('text-red-600');
                } else if (!hasValidStatus) {
                    nextLabel.textContent = `Next: ${formatTrackingStatus(trackingStatuses[0])}`;
                    nextLabel.classList.remove('text-red-600');
                } else if (activeIndex >= totalSteps - 1) {
                    nextLabel.textContent = 'All steps completed';
                    nextLabel.classList.remove('text-red-600');
                } else {
                    const upcoming = trackingStatuses[activeIndex + 1];
                    nextLabel.textContent = `Next: ${formatTrackingStatus(upcoming)}`;
                    nextLabel.classList.remove('text-red-600');
                }
            }

            if (remainingLabel) {
                if (isCancelled) {
                    remainingLabel.textContent = 'This order was cancelled before completion.';
                } else if (!hasValidStatus) {
                    remainingLabel.textContent = 'We will show the remaining steps once your order is confirmed.';
                } else if (activeIndex >= totalSteps - 1) {
                    remainingLabel.textContent = 'All steps are complete. Enjoy your meal!';
                } else {
                    const remainingSteps = trackingStatuses
                        .slice(activeIndex + 1)
                        .map(formatTrackingStatus);
                    remainingLabel.textContent = `Still to come: ${remainingSteps.join(' → ')}`;
                }
            }
        }

        function formatDate(value) {
            try {
                const date = new Date(value);
                if (!isNaN(date.getTime())) {
                    return date.toLocaleString('en-US', {
                        year: 'numeric',
                        month: 'short',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                }
            } catch (error) {
                console.warn('Unable to format date', value, error);
            }
            return value;
        }

        const detailPaymentStatusClassMap = {
            'PENDING': 'payment-PENDING',
            'AWAITING_SESSION': 'payment-AWAITING_SESSION',
            'AWAITING_WEBHOOK': 'payment-AWAITING_WEBHOOK',
            'CASH_PENDING': 'payment-CASH_PENDING',
            'PROCESSING': 'payment-PROCESSING',
            'COMPLETED': 'payment-COMPLETED',
            'FAILED': 'payment-FAILED',
            'CANCELLED': 'payment-CANCELLED',
            'REFUNDED': 'payment-REFUNDED'
        };

        function updatePaymentStatus(element, status) {
            if (!element) {
                return;
            }

            element.textContent = formatEnumValue(status) || 'N/A';
            element.className = 'payment-badge';

            if (status && detailPaymentStatusClassMap[status]) {
                element.classList.add(detailPaymentStatusClassMap[status]);
            }
        }

        function formatTrackingStatus(status) {
            if (!status) {
                return '';
            }
            return trackingStatusFriendlyNames[status] || formatEnumValue(status);
        }

        function formatEnumValue(value) {
            if (!value) {
                return '';
            }

            return value
                .toString()
                .split('_')
                .map(part => part.charAt(0) + part.slice(1).toLowerCase())
                .join(' ');
        }
    </script>
</body>
</html>
